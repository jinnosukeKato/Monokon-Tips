# ものコンテクニック集

具体的なコードは[こちら](https://github.com/jinnosukeKato/Monokon-Template/blob/master/monokon_template.ino)

## 解き方

各部品の制御ごとに関数にして、それを組み立てるようにするのが基本

それぞれの具体的な実装は[俺の書いたコード](https://github.com/jinnosukeKato/Monokon-Kanagawa-2022)を参考程度にどうぞ  
**まずは自分で考えてみよう**

## アルゴリズム

### 一度しか動かさなくてよいもの(起動後だけ)

`void setup() {}`の中に書く  
`pinMode`とかをよく書く

#### pinMode について

実は書かなくても動作する場合がほとんどだが、[リファレンス](https://docs.arduino.cc/learn/microcontrollers/digital-pins)にあるように、
`pinMode`は内部インピーダンスを変更しているので、ちゃんと記述したほうが良い

### ボタンが押されたらor押されている間の処理

`if`よりも`while`を使ったほうが簡単なことが結構ある

## 入力処理

回路の作る人によってプルアップ・プルダウンとかコネクタのパターン変わると思うから臨機応変に対応できるとよい

`#define`でピン番号とかは置き換えするのがベター  
できれば練習から統一しておくと楽

例)
```c++
#define BUTTON_PIN 22
#define BUTTON_ON HIGH
```

### タクトスイッチ

普通に`digitalRead`で読み取ってやればいい

### フォトダイオード

アナログ値を出力してるけど、半分隠すとか問題に出てこないので`digitalRead`でいいと思う

### 可変抵抗

`analogRead`で読み取って値の範囲で分岐させることが求められることが多い  
**analogReadの場合、ピンはAから始まる番号になる** `例) A0, A1, A2`  
`pinMode(A1, INPUT);`も忘れずに

0から1023までの値で読み取れる

## 部品制御

### クロック

5番ピンに入れるパルス信号のこと

DCモータとステッピングモータを制御するときに必要(Dフリップフロップが間にあるため)

間隔が短すぎるとステッピングモータが回らない場合がある  
長すぎると7セグなどの動作に支障をきたす場合が多い

```c++
void clock() {
  digitalWrite(5, HIGH);
  delay(3); //2-5msくらいがよい
  digitalWrite(5, LOW);
}
```

### DCモータ

クロックが必要
Arduino側電源を抜いても動き続ける(うるさいから気を付けたほうがいい)

LOWを入れて止めると若干惰性で動くので、ピタっと止めたい場合は下のようにする

```c++
digitalWrite(16, HIGH); // 両側にHIGHを入れる
digitalWrite(17, HIGH);
clock();
delay(5); // ちょっと待つ
digitalWrite(16, LOW); // 負荷がかかるのでLOWにしたほうがいいと思う
digitalWrite(17, LOW);
clock();
```

### ステッピングモータ

12-15番ピンに下図パターン通りに信号を送り、クロックを入れると4ステップ分進む  
1番パターン送信→クロック→2番パターン送信→クロック...のように合間にクロックを送ればよい  
1ステップ3度なので下図パターンで12度回転する

|     | 12番ピン | 13番ピン | 14番ピン | 15番ピン  | 
| :-: | :------: | :------: | :------: | :------: | 
| 1   | HIGH     | HIGH     | LOW      | LOW      | 
| 2   | LOW      | HIGH     | HIGH     | LOW      | 
| 3   | LOW      | LOW      | HIGH     | HIGH     | 
| 4   | HIGH     | LOW      | LOW      | HIGH     | 

↑これで4ステップ分進む

二次元配列を使ってパターンを作ると便利
逆回ししたいときはパターンを逆から回せばよい  
部品は[これ](https://akizukidenshi.com/catalog/g/gP-11839/) 
関東大会とは部品が違うので注意

### ブザー

`analogWrite`で100くらい入れてやると音が鳴る `digitalWrite`では鳴らないので注意

```c++
analogWrite(4, 100); // ON
analogWrite(4, 0); // OFF
```

[`tone`](https://www.arduino.cc/reference/en/language/functions/advanced-io/tone/)を使うと周波数の指定ができ、消音する処理がいらなくなる

### 7セグメント

ピンは一番上のセグメントから時計周りで最後に中央→点と覚えると簡単

下のコードのように二次元配列を用いてパターン作成すると良いと思う  
`HIGH`, `LOW` を使わずに `1`, `0` を使うとミスがわかりやすくていい

```c++
int segPattern[10][8] = {
  {1, 1, 1, 1, 1, 1, 0, 0}, //　0
  {0, 1, 1, 0, 0, 0, 0, 0}, //　1
  ...
  {0, 0, 0, 0, 0, 0, 0, 0} //　消灯
};
```

消灯パターンや`r`, `l`表示も使うことがあるので入れておくといいかも

**12-15番ピンはステッピングモータと、16-17はDCモータと共用なので注意**

#### 7セグメント両側同時点灯

~2番と3番を高速に切り替えてあげればいい~  
~それぞれ10ms程度光らせてあげる(delayを挟む)とちらつき・ぼやつきがない~  
~かなりシビアなので10ms程度を基準に調整してみてほしい~

下記のようにすることでdelayが不要になることを発見

```c++
// 右セグメント点灯
void segR(int num) {
  seg(10);// ここでリセットかけるとdelayいらない
  digitalWrite(2, LOW);
  digitalWrite(3, HIGH);
  seg(num);
}

void segL(int num){
  // 左も同様に
}

void segW(int left, int right) {
  segL(left);
  delay(1); // 点灯する時間を少し設けたほうがいい
  segR(right);
  delay(1); // 直接loop()に入れるなら不要
}
```

#### 7セグメント点灯+DCモータ回転

DCモータは一度クロックを入れるとずっと回ってくれるので、それを利用してDCモータ制御→セグメント制御の順番にするといい

#### 7セグメント両点灯+ステッピングモータ回転

```c++
void segAndStep(int l, int r) {
  for (int n = 0; n < 4; n++) {
    digitalWrite(2, LOW); // 消しとくと事故が起きにくい
    digitalWrite(3, LOW);
    step(n); // 1ステップ進ませる関数
    segL(l); // 左セグメントを点灯させる関数
    delay(1); // ここを調整 (1ステップ進めるのに要する時間より点灯時間を長くすると違和感が少ない) 
    segR(r); // 右セグメントを点灯させる関数
    delay(1); // ここも調整
  }
}
```

このように、1ステップ進ませる中に割り込ませるのがいいと思われる

DCモータが動いちゃうときは16,17番ピンをLOWにしてからクロックを送るように修正するとよい

delayが長いほど光り方が弱まってしまうので、ベストな光の具合になるようにアルゴリズムやdelayの秒数を研究してほしい  
また、クロックのdelayを1msとかに設定してもステッピングモータが回る場合があるので、そこも調整してみてほしい

## 以下は直接関係ない内容です

<details>
<summary>気になる人だけ読んでもらえればOKです</summary>

### IDEの選択

Arduino IDE は v2.0 を強く推奨する  
設定で有効化すると関数名等の補完が効く

Arduino IDE を使うのが標準だけど、 Jetbrains の [CLion](https://www.jetbrains.com/ja-jp/clion/) などの強力なIDEを使用すると良いかもしれない

ちなみに Jetbrains の IDE は学生ならすべて無料なので強くお勧めする

### 言語仕様

俺はC系に詳しくないので間違ってたらごめんなさい
  
`HIGH`は0以外の値、`LOW`は0と等価なので、bit演算を使うと早く解ける問題があるかもしれない

Cに準拠していると思われがちなArduino言語だけど、実はC++11なのでfor-eachとかが普通に使える  
正確には`avr-g++`でAVR向けに[クロスコンパイルしている](https://garretlab.web.fc2.com/arduino/introduction/compile_process/)  
なので設定ファイルいじったりコンパイラ差し替えればC++17なども使用可能  
詳しくは Arduino forum とかを漁ると[出てくる](https://forum.arduino.cc/t/arduino-and-c-17-avr-gcc-8-x/545021/2)かも  
ゲームのエンジンを触ったことがあったり最新のC++に造詣が深い人は試してみてほしい

そもそもAVR向けにコンパイルできる言語かつ、Cのヘッダファイルを読み込める言語であれば、どんな言語でもArduino向けのプログラム自体は記述可能

### 採点について

県大会はプログラムの内容の採点は1問目しかされなかった(2021, 2022)
